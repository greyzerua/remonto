rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // БЕЗПЕЧНІ ПРАВИЛА ДЛЯ ПРОДАКШЕНУ

    // Користувачі
    match /users/{userId} {
      allow read: if request.auth != null;
      
      // Дозволити оновлення власнику або користувачу, який є в sharedUsers
      // Це дозволяє користувачу видалити себе зі списку sharedUsers
      // АБО власнику видалити іншого користувача зі свого sharedUsers
      // Також дозволяємо оновлювати FCM токен та налаштування нотифікацій
      allow update: if request.auth != null && (
        request.auth.uid == userId ||
        (request.auth.uid in resource.data.get('sharedUsers', []) &&
         // Дозволяємо sharedUsers оновлювати FCM токен та налаштування нотифікацій
         (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['fcmToken', 'notificationsEnabled', 'tokenUpdatedAt']) ||
          // АБО дозволяємо видалити себе зі списку sharedUsers
          // Перевіряємо: користувач був в старому списку, немає в новому, і змінюється тільки sharedUsers
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['sharedUsers']) &&
           request.auth.uid in resource.data.get('sharedUsers', []) &&
           !(request.auth.uid in request.resource.data.get('sharedUsers', [])))))
      );
      
      allow create, delete: if request.auth != null && request.auth.uid == userId;
    }

    // Проекти
    match /projects/{projectId} {
      allow read: if request.auth != null;
      
      allow create: if request.auth != null && 
        request.resource.data.createdBy == request.auth.uid;
      
      // Allow update to owner or project members
      // Also allow a member to remove themselves from the members list
      allow update: if request.auth != null && (
        request.auth.uid == resource.data.createdBy ||
        request.auth.uid in resource.data.get('members', [])
      );
      
      // Allow delete only to owner
      allow delete: if request.auth != null && 
        request.auth.uid == resource.data.createdBy;
    }

    // Витрати
    match /expenses/{expenseId} {
      allow read: if request.auth != null;
      
      allow create: if request.auth != null && 
        request.resource.data.createdBy == request.auth.uid;
      
      // Allow update/delete to creator or any user with project access
      allow update, delete: if request.auth != null && (
        request.auth.uid == resource.data.createdBy ||
        (exists(/databases/$(database)/documents/projects/$(resource.data.projectId)) &&
         (get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.createdBy == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.get('members', [])))
      );
    }
  }
}

